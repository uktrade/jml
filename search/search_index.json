{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Leaving DBT Service","text":""},{"location":"#developer-notes","title":"Developer notes","text":"<p>Notes that must be read and understood by developers working on the service.</p>"},{"location":"#uk-sbs-person-id","title":"UK SBS Person ID","text":"<p>The <code>person_id</code> field that we get back from UK SBS must NOT be exposed to any end user of the service, it must also not be exposed in any logs on this service. This field contains sensitive information that is only to be used for the purposes of getting Hierarchy data from the UK SBS API and submitting it back to UK SBS to inform them of a Leaver.</p>"},{"location":"#getting-started","title":"Getting started","text":""},{"location":"#dependencies","title":"Dependencies","text":"<p>To get the project running locally, you will need to have Docker installed.</p>"},{"location":"#running-the-project","title":"Running the project","text":"<p>First you will need to make a copy of the <code>.env.example</code> file and rename it to <code>.env</code>. This file contains all the environment variables that the project needs to run.</p> <pre><code>cp .env.example .env\n</code></pre> <p>There might be some values that you need to configure, talk to SRE for these values.</p> <p>Next, you will need to copy the example local settings file and rename it to <code>local.py</code>. This file contains all the settings that the project needs to run.</p> <pre><code>cp config/settings/local.example.py config/settings/local.py\n</code></pre> <p>Now you can run the <code>make setup</code> command to set up the site.</p> <pre><code>make setup\n</code></pre> <p>This will result in the webserver being served on port <code>8000</code>.</p> <p>It should be accessible at:</p> <ul> <li>http://localhost:8000/</li> <li>http://0.0.0.0:8000/</li> </ul>"},{"location":"#dev-tools","title":"Dev tools","text":"<p>The first page you see when you set up the project for the first time should be the Dev tools page. This page contains a drop down form so you can select from a list of pre-made users. It also contains a form for you to create your own users.</p> <p></p>"},{"location":"#preconfigured-users","title":"Preconfigured users","text":"<p>The following users already exist, and some of them have behaviors that are useful for testing the service.</p> Name Groups Notes John Smith Hardware Team Jane Doe SRE Miss Marple HR Thomas Anderson Security Team Charlotte Blackwood Asset Team John Watson Hardware Team Has a digital.trade.gov.uk email address"},{"location":"e2e-testing/","title":"End-to-end tests","text":"<p>These E2E tests are intended to cover the most important parts of the application. The scenarios are written with the assumption that you are testing locally or on dev/staging.</p> <p>Setup some test data:</p> <ul> <li>Create a new user to be a leaver<ul> <li>Go to \"Dev tools\" and fill out the \"Create user\" form</li> </ul> </li> <li>Create a new user to be the leaver's manager<ul> <li>Go to \"Dev tools\" and fill out the \"Create user\" form</li> </ul> </li> <li>Create a new user to be a HR admin<ul> <li>Go to \"Dev tools\" and fill out the \"Create user\" form</li> <li>Make sure to set the \"Group\" to \"HR\"</li> </ul> </li> <li>Create a new user to be an SRE admin<ul> <li>Go to \"Dev tools\" and fill out the \"Create user\" form</li> <li>Make sure to set the \"Group\" to \"SRE\"</li> </ul> </li> <li>Create a new user to be an Security admin<ul> <li>Go to \"Dev tools\" and fill out the \"Create user\" form</li> <li>Make sure to set the \"Group\" to \"Security Team\"</li> </ul> </li> </ul>"},{"location":"e2e-testing/#leaver-journey","title":"Leaver Journey","text":"<p>Using dev tools, in the \"Change user\" form, select the leaver user you created and click \"Select user\".</p> <ul> <li>Navigate to <code>/leavers/start/</code></li> <li>Press \"Start\"</li> <li>Select \"I am leaving the department\"</li> <li>Fill out the forms using realistic data (don't use real names, emails, etc)</li> <li>Who is your line manager?<ul> <li>Select the manager user you created</li> </ul> </li> <li>At the end, you should see a confirmation page, submit this request and the leaver's part of the process is complete</li> </ul>"},{"location":"e2e-testing/#manager-journey","title":"Manager Journey","text":"<p>Using dev tools, in the \"Change user\" form, select the manager user you created and click \"Select user\".</p> <ul> <li>In the navigation menu, a new item should be visible: \"Start Line Manager process\"<ul> <li>Clicking this should take you to the manager section of the offboarding process for the leaver you just created</li> </ul> </li> <li>Press \"Start\"</li> <li>Confirm all of the details are correct and fill out the new fields as required</li> <li>At the end, you should see a confirmation page, submit this request and the manager's part of the process is complete</li> </ul>"},{"location":"e2e-testing/#hr-admin-journey-viewing-submitted-requests","title":"HR Admin Journey (Viewing Submitted Requests)","text":"<p>Using dev tools, in the \"Change user\" form, select the HR admin user you created and click \"Select user\".</p> <ul> <li>You should now see a new item in the navigation menu: \"Leaving Requests\" <code>/leavers/leaving-requests/</code><ul> <li>Clicking this should take you to a list of all leaving requests</li> </ul> </li> <li>In the list of \"Incomplete\" requests, click on the leaver you created</li> <li>You should now see a summary of the leaver's request and it's actions</li> </ul>"},{"location":"e2e-testing/#hr-admin-journey-create-a-new-leaver","title":"HR Admin Journey (Create a new leaver)","text":"<p>Using dev tools, in the \"Change user\" form, select the HR admin user you created and click \"Select user\".</p> <ul> <li>You should now see a new item in the navigation menu: \"Leaving Requests\" <code>/leavers/leaving-requests/</code><ul> <li>Clicking this should take you to the page where you can \"Create a new leaver\".</li> </ul> </li> <li>Click on the \"Start\" button to manually off-board someone.<ul> <li>Select the person you want to off-board by typing their name in the search bar.<ul> <li>Click on the \"Select\" button displayed next to the leaver's name.</li> </ul> </li> <li>Click on the \"Continue\" button to fill in the forms on behalf of the leaver.</li> <li>At the end, you should see a confirmation page, submit this request and the leaver's details part of the process is complete.</li> </ul> </li> <li>To complete the offboarding click on \"Start\" button to confirm all the details and to add further information as needed.</li> <li>After confirming all the information you can complete the process via \"Accept and send\" button.</li> </ul>"},{"location":"e2e-testing/#sre-journey","title":"SRE Journey","text":"<p>Using dev tools, in the \"Change user\" form, select the SRE admin user you created and click \"Select user\".  team</p> <ul> <li>You should now see a new item in the navigation menu: \"Leaving Requests\" <code>/leavers/leaving-requests/sre/incomplete-leaving-request/</code><ul> <li>Clicking this should take you to a list of submitted leaving requests that are ready for the SRE team to action</li> </ul> </li> <li>Select the request for the leaver you created<ul> <li>You should see the information from the request that is helpful to the SRE team</li> <li>You should be able to do the following tasks:<ul> <li>For each tool listed:<ul> <li>Mark it as:<ul> <li>Not started</li> <li>Not applicable</li> <li>Removed</li> </ul> </li> <li>Add notes to the tool</li> </ul> </li> <li>Mark the record as complete<ul> <li>This is only possible if all of the tools have been marked as \"Removed\" or \"Not applicable\"</li> </ul> </li> </ul> </li> </ul> </li> </ul>"},{"location":"e2e-testing/#security-journey","title":"Security Journey","text":"<p>Using dev tools, in the \"Change user\" form, select the Security admin user you created and click \"Select user\".</p> <ul> <li>You should now see a new item in the navigation menu: \"Leaving Requests\" <code>/leavers/leaving-requests/security-team/incomplete-leaving-request/</code><ul> <li>Clicking this should take you to a list of submitted leaving requests that are ready for the Security team to action</li> </ul> </li> <li>There are 2 tabs on this page \"Security requests\" and \"ROSA Kit requests\"<ul> <li>On the \"Security requests\" tab, click on the leaver you created<ul> <li>You should see the information from the request that is helpful to the security team</li> <li>You should be able to do the following tasks:<ul> <li>Mark the building pass as:<ul> <li>Deactivated</li> <li>Returned</li> <li>Destroyed</li> </ul> </li> <li>Mark the security clearance as:<ul> <li>Active</li> <li>Lapsed</li> <li>Paused</li> <li>Other (with a text field to explain)</li> </ul> </li> <li>Add comments to the request</li> <li>Mark the record as complete<ul> <li>This is only possible if all of the above fields are filled out</li> </ul> </li> </ul> </li> </ul> </li> <li>On the \"ROSA Kit requests\" tab, click on the leaver you created (the leaver will only show here if in the request it was flagged that they have ROSA equipment)<ul> <li>You should see the information from the request that is helpful to the Security team</li> <li>You should be able to do the following tasks:<ul> <li>Set each equipment as:<ul> <li>Not started</li> <li>Not applicable</li> <li>Returned</li> </ul> </li> <li>Add notes to each piece of equipment</li> <li>Mark the record as complete<ul> <li>This is only possible if all of the equipment has been marked as \"Returned\" or \"Not applicable\"</li> </ul> </li> </ul> </li> </ul> </li> </ul> </li> </ul>"},{"location":"s3_ingest/","title":"S3 ingest","text":""},{"location":"s3_ingest/#staff-sso-files","title":"Staff SSO files","text":"<p>Files containing a full extract of data in the staff SSO system will be delivered twice a day, to the JML S3 bucket in the file key format <code>data-flow-exports/StaffSSOUsersPipeline/TIMESTAMP/full_ingestion.jsonl.gz</code>. The delivery time is not guaranteed, as data flow produces these files as part of its pipeline scheduler. The pipeline to produce this file is scheduled to begin at 00.00 UTC and 12.00 UTC every day, however due to the number of pipelines in data flow it can sometimes take hours to obtain a free worker to produce the staff SSO file. The file generated at 12.00 UTC will usually be delivered quickly after the scheduled start time, as most pipelines in data flow are scheduled to run overnight</p>"},{"location":"s3_ingest/#file-format","title":"File format","text":"<p>The file delivered will be a gzip compressed jsonl file, containing 1 line per entry in the staff SSO system. Using jsonl means the file can be streamed from S3 and read 1 line at a time in a similar way to a CSV file. If using the <code>smart_open</code> package to read the file, the file will be automatically decompressed when it detects a <code>.gz</code> file extension.</p>"},{"location":"s3_ingest/#file-contents","title":"File contents","text":"<p>The contents of this file will be the same json structure produced by the activity stream API, this is an example of the output <pre><code>{\"published\": \"2024-09-04T14:58:05.864Z\", \"object\": {\"id\": \"dit:StaffSSO:User:d1966051-cabc-40f2-8b56-16d42e30971f\", \"type\": \"dit:StaffSSO:User\", \"name\": \"Mr. Ernest Ramos DDS\", \"dit:StaffSSO:User:userId\": \"d1966051-cabc-40f2-8b56-16d42e30971f\", \"dit:StaffSSO:User:emailUserId\": \"ograham@example.net\", \"dit:StaffSSO:User:contactEmailAddress\": \"kaylamiller@example.com\", \"dit:StaffSSO:User:joined\": \"2024-09-04T14:58:05.867Z\", \"dit:StaffSSO:User:lastAccessed\": \"2024-09-04T14:58:05.867Z\", \"dit:StaffSSO:User:permittedApplications\": [], \"dit:StaffSSO:User:status\": \"inactive\", \"dit:StaffSSO:User:becameInactiveOn\": \"2024-09-04T14:58:05.867Z\", \"dit:firstName\": \"Roberta\", \"dit:lastName\": \"Brown\", \"dit:emailAddress\": [\"jlee@example.net\"]}}\n</code></pre></p>"},{"location":"s3_ingest/#data-verification","title":"Data verification","text":"<p>The data flow pipeline has a data integrity check that runs before any S3 files are delivered to a downstream bucket. For the staff SSO file, if the new file contains less than 95% of the previous file then the file is not copied and an error thrown in the data flow system for more investigation.</p>"},{"location":"technical-documentation/","title":"Technical documentation","text":""},{"location":"technical-documentation/#project-structure","title":"Project structure","text":"Folder name Description <code>activity_stream/</code> Manages the integration with Staff SSO <code>asset_registry/</code> Holds code for the asset registry that was an early prototype during discovery <code>config/</code> Django settings and top-level project config <code>core/</code> Common code and integrations with external systems <code>dev_tools/</code> Django app for tooling that helps with development <code>docs/</code> Documentation for the project <code>leavers/</code> Django app for processing leavers <code>myignore/</code> A Git ignored folder for you to place any code that you don't want to commit, but find useful"},{"location":"technical-documentation/data-sources/","title":"Data Sources","text":""},{"location":"technical-documentation/data-sources/#internal-systems","title":"Internal systems","text":""},{"location":"technical-documentation/data-sources/#people-finder-digital-workspace","title":"People Finder (Digital Workspace)","text":"<ul> <li>want the people finder data</li> <li>rest api with hawk authentication</li> <li>ingest it all in one go daily</li> <li>1 request per page <code>R(n / page_size)</code></li> <li>activity_stream/staff_sso.py</li> </ul>"},{"location":"technical-documentation/data-sources/#activity-stream","title":"Activity Stream","text":"<ul> <li>want the sso data</li> <li>rest api with hawk authentication</li> <li>ingest it all in one go daily</li> <li>1 request per 1000 hits (paged) <code>R(n / 1000)</code></li> <li>core/people_finder/client.py</li> </ul>"},{"location":"technical-documentation/data-sources/#data-workspace","title":"Data Workspace","text":"<ul> <li>want the people data report</li> <li>connection/copy or the table/database</li> <li>1 query per person <code>Q(n)</code></li> <li>core/people_data/interfaces.py</li> </ul>"},{"location":"technical-documentation/data-sources/#external-systems","title":"External systems","text":""},{"location":"technical-documentation/data-sources/#uksbs","title":"UKSBS","text":"<ul> <li>requests are made as part of the leavers journey</li> <li>hierarchy (line manager) <code>R(n)</code></li> <li>hierarchy (line reports) <code>R(n)</code></li> <li>while loop:<ul> <li>try get leaver <code>R(n)</code></li> </ul> </li> <li>while loop:<ul> <li>try get leavers line manager <code>R(n)</code></li> </ul> </li> <li>post to uksbs <code>R(n)</code></li> </ul> <p>range = <code>R(5n)</code> -&gt; <code>R(inf(n))</code></p>"},{"location":"technical-documentation/data-sources/#servicenow","title":"ServiceNow","text":"<ul> <li>want the equipment data</li> <li>rest api</li> <li>ingest it all in one go daily</li> <li>2 request per person <code>R(2n)</code></li> <li>core/service_now/utils.py</li> </ul>"},{"location":"technical-documentation/emails/","title":"Emails","text":""},{"location":"technical-documentation/emails/#leaver-and-line-manager-emails","title":"Leaver and Line Manager emails","text":"Email name Template ID Environment Variable Context/Notes Leaver Thank You Email TEMPLATE_ID_LEAVER_THANK_YOU_EMAIL This email is sent after the Leaver has informed the service that they are leaving. Leaver Questionnaire Email TEMPLATE_ID_LEAVER_QUESTIONNAIRE_EMAIL This email is sent after the Leaver has informed the service that they are leaving. Leaver not in UK SBS (HR) Email TEMPLATE_ID_LEAVER_NOT_IN_UKSBS_HR_REMINDER ??? Leaver not in UK SBS (LM) Email TEMPLATE_ID_LEAVER_NOT_IN_UKSBS_LM_REMINDER ??? UKSBS Line Manager Missing Person ID Email TEMPLATE_ID_LINE_MANAGER_MISSING_PERSON_ID_EMAIL This email is sent to ??? in an attempt to get the missing Person ID issue resolved. UKSBS Line Manager Correction Email (UK SBS manager) TEMPLATE_ID_LINE_MANAGER_CORRECTION_EMAIL This email is sent to the listed Line Manager in UK SBS to request that they update the Line Manager to be the one that the Leaver selected UKSBS Line Manager Correction Email (Offboarding team) TEMPLATE_ID_LINE_MANAGER_CORRECTION_HR_EMAIL This email is sent to the HR Offboarding team to request they update the Line Manager in UK SBS to be the one that the Leaver selected. UKSBS Line Manager Correction Email (Reported Line Manager) TEMPLATE_ID_LINE_MANAGER_CORRECTION_REPORTED_LM_EMAIL This email is sent to the Line Manager that the Leaver selected to inform them that they are not the manager in UK SBS and that the HR team must fix this for them to be able to offboard the Leaver. Line Manager Notification Email TEMPLATE_ID_LINE_MANAGER_NOTIFICATION_EMAIL This email is sent to the Line Manager to inform them of the leaver and the actions they need to take. Line Manager Reminder Email TEMPLATE_ID_LINE_MANAGER_REMINDER_EMAIL This email is sent to remind the Line Manager of the actions they need to take. Line Manager Thank You Email TEMPLATE_ID_LINE_MANAGER_THANKYOU_EMAIL This email is sent to the Line Manager once they have finished their journey. Leaver Final Actions Email ??? This email is sent to the Leaver in their last working week to inform them of the actions they need to take. Line Manager Final Actions Email ??? This email is sent to the Line Manager in the leaver's last working week to inform them of the actions they need to take."},{"location":"technical-documentation/emails/#leaver-and-line-manager-reminder-logic","title":"Leaver and Line Manager reminder logic","text":"Email 2 weeks away 1 week away (from last working day) Daily for last week Last working day Leaving date Daily after last working day Daily after leaving date Line Manager Reminder Email X X X X Leaver Final Actions Email X X Line Manager Final Actions Email X X ROSA Leaver Reminder Email X X X X ROSA Line Manager Reminder Email X X X X"},{"location":"technical-documentation/emails/#processor-emails","title":"Processor emails","text":"<p>These are notification emails sent to the processor:</p> Email name Template ID Environment Variable Context/Notes Security Clearance Leaver Email TEMPLATE_ID_CLU4_EMAIL This email is sent vetting to inform them of the leaver. Feetham Security Pass Office Leaver Notification Email TEMPLATE_ID_FEETHAM_SECURITY_PASS_OFFICE_EMAIL This email is sent to the Feetham Security Pass Office to inform them of the leaver and their reported assets. IT Ops Leaver Notification Email TEMPLATE_ID_IT_OPS_ASSET_EMAIL This email is sent to the IT Ops team to inform them of the leaver and their reported assets. OCS Leaver Notification Email TEMPLATE_ID_OCS_LEAVER_EMAIL This email is sent to OCS to inform them of the leaver. OCS Leaver OAB Locker Email TEMPLATE_ID_OCS_OAB_LOCKER_EMAIL This email is sent to the OAB Locker team to inform them of the leaver. OCS Leaver OAB Locker Email TEMPLATE_ID_COMAEA_EMAIL This email is sent to the OAB Locker team to inform them of the leaver."},{"location":"technical-documentation/emails/#processor-reminder-logic","title":"Processor reminder logic","text":"<p>Once the Line Manager has processed a Leaving request, the following processors need to be informed and reminded to perform their tasks:</p> <ul> <li>Security building pass team</li> <li>Security ROSA kit team</li> <li>SRE team (no Line Manager emails)</li> <li>IT Ops team</li> </ul> <p>Emails are sent at the following points:</p> When Condition Purpose Recipient Day after the last working day ALWAYS Notification email to inform the Processor of the tasks Processor 2 days after the last working day IF NOT PROCESSED Notification email to inform the Line Manager of the tasks Line Manager On the leaving date IF NOT PROCESSED URGENT: Inform the Line Manager that the tasks need to be performed Line Manager 1 day after the leaving date IF NOT PROCESSED Inform the Processor that the tasks need to be performed Processor 5 days after the leaving date IF NOT PROCESSED Inform the Line Manager that the tasks need to be performed by end of the day otherwise escalation Line Manager 5 days after the leaving date IF NOT PROCESSED Inform the Processor that the tasks need to be performed by end of the day otherwise escalation Processor"},{"location":"technical-documentation/emails/#security-building-pass-team","title":"Security building pass team","text":"<p>Only send these reminders if the Building pass hasn't been marked as destroyed.</p>"},{"location":"technical-documentation/emails/#security-rosa-kit-team","title":"Security ROSA kit team","text":"<p>Only send these reminders if the ROSA kit tasks haven't been marked as completed/closed.</p>"},{"location":"technical-documentation/emails/#sre-team","title":"SRE team","text":"<p>Only send these reminders if the SRE tasks haven't been marked as completed. There is no need to send any of the emails to the Line Manager for SRE.</p>"},{"location":"technical-documentation/emails/#it-ops-team","title":"IT Ops team","text":"<p>Only send these reminders if the Leaver has assets that are considered \"risky\" (Laptop, mobile phone, etc).</p>"},{"location":"technical-documentation/environment-variables/","title":"Environment Variables","text":"Environment variable Default Notes DEV_TOOLS_ENABLED false Set this value to \"true\" to enable Dev Tools and disable Authbroker SLACK_API_TOKEN None SLACK_SRE_CHANNEL_ID None PEOPLE_FINDER_HAWK_ACCESS_ID PEOPLE_FINDER_HAWK_SECRET_KEY PEOPLE_FINDER_URL PEOPLE_FINDER_INTERFACE STAFF_SSO_ACTIVITY_STREAM_URL None STAFF_SSO_ACTIVITY_STREAM_ID None STAFF_SSO_ACTIVITY_STREAM_SECRET None SERVICE_NOW_OFFLINE_URL True Set this value to the url we should send the Line manager to when manually offboarding from ServiceNow SERVICE_NOW_ENABLE_ONLINE_PROCESS True Set this value to \"false\" to revert back to the offline Service Now journey SERVICE_NOW_INTERFACE None SERVICE_NOW_API_URL None SERVICE_NOW_POST_LEAVER_REQUEST None SERVICE_NOW_GET_ASSET_PATH None SERVICE_NOW_GET_USER_PATH None SERVICE_NOW_GET_DIRECTORATE_PATH None SERVICE_NOW_DIT_DEPARTMENT_SYS_ID None LEGACY_PEOPLE_FINDER_ES_INDEX None LEGACY_PEOPLE_FINDER_ES_URL None CLU4_EMAIL None Email address for the CLU4 Team OCS_EMAIL None Email address for the OCS Team OCS_OAB_LOCKER_EMAIL None Email address for the OCS OAB Locker Team SECURITY_TEAM_VETTING_EMAIL None Email address for the Security Team (vetting) SRE_EMAIL None Email address for the SRE Team HR_UKSBS_CORRECTION_EMAIL None Email address for the HR Team member that deals with UK SBS corrections COMAEA_EMAIL None Email address for the COMAEA team BUSINESS_CONTINUITY_EMAIL None Email address for the Business Continuity team DIT_OFFBOARDING_EMAIL '' JML_TEAM_CONTACT_EMAIL '' JML_TEAM_EMAILS [] JML_ONLY_SEND_EMAILS_TO_JML_TEAM False Whether to only send emails to the JML team. Used on staging to stop GOV.UK Notify errors. JML_LEAVING_DIT_GUIDANCE_URL '' The URL for the leaving DIT guidance. This is normally a page in Digital Workspace. DIT_LOANS_GUIDANCE_URL '' The URL for the DIT loans guidance. This is normally a page in Digital Workspace. GOVUK_NOTIFY_API_KEY None HELP_DESK_CREDS None Dict of credentials for help desk: format will depend on helpdesk HELP_DESK_INTERFACE help_desk_client.interfaces.HelpDeskStubbed Help desk interface to use, use the stub for local dev/tests LSD_HELP_DESK_LIVE false Set to 'true' if you want to create help desk tickets, default behaviour will just stub the request SEARCH_HOST_URLS None OpenSearch URL SEARCH_STAFF_INDEX_NAME staff INDEX_CURRENT_USER_MIDDLEWARE false UKSBS_INTERFACE None UKSBS_HIERARCHY_API_URL None UK SBS People Hierarchy URL UKSBS_GET_PEOPLE_HIERARCHY None UK SBS People Hierarchy path UKSBS_LEAVER_SUBMISSION_API_URL None UK SBS Leaver Submission URL UKSBS_POST_LEAVER_SUBMISSION None UK SBS Leaver Submission path GPC_RETURN_ADDRESS [] Set as the comma separated list of each address line for the GPC Return Address TEMPLATE_ID_LEAVER_THANK_YOU_EMAIL None TEMPLATE_ID_LEAVER_QUESTIONNAIRE_EMAIL None TEMPLATE_ID_LEAVER_NOT_IN_UKSBS_HR_REMINDER None TEMPLATE_ID_LEAVER_NOT_IN_UKSBS_LM_REMINDER None TEMPLATE_ID_LINE_MANAGER_CORRECTION_EMAIL None TEMPLATE_ID_LINE_MANAGER_CORRECTION_HR_EMAIL None TEMPLATE_ID_LINE_MANAGER_CORRECTION_REPORTED_LM_EMAIL None TEMPLATE_ID_LINE_MANAGER_NOTIFICATION_EMAIL None TEMPLATE_ID_LINE_MANAGER_REMINDER_EMAIL None TEMPLATE_ID_LINE_MANAGER_THANKYOU_EMAIL None TEMPLATE_ID_LINE_MANAGER_OFFLINE_SERVICE_NOW_EMAIL None TEMPLATE_ID_CLU4_EMAIL None TEMPLATE_ID_FEETHAM_SECURITY_PASS_OFFICE_EMAIL None TEMPLATE_ID_IT_OPS_ASSET_EMAIL None TEMPLATE_ID_OCS_LEAVER_EMAIL None TEMPLATE_ID_OCS_OAB_LOCKER_EMAIL None TEMPLATE_ID_COMAEA_EMAIL None TEMPLATE_ID_BUSINESS_CONTINUITY_LEAVER_EMAIL None TEMPLATE_ID_SECURITY_TEAM_OFFBOARD_BP_LEAVER_EMAIL None TEMPLATE_ID_SECURITY_OFFBOARD_BP_REMINDER_DAY_AFTER_LWD None TEMPLATE_ID_SECURITY_OFFBOARD_BP_REMINDER_TWO_DAYS_AFTER_LWD None TEMPLATE_ID_SECURITY_OFFBOARD_BP_REMINDER_ON_LD None TEMPLATE_ID_SECURITY_OFFBOARD_BP_REMINDER_ONE_DAY_AFTER_LD None TEMPLATE_ID_SECURITY_OFFBOARD_BP_REMINDER_TWO_DAYS_AFTER_LD_LM None TEMPLATE_ID_SECURITY_OFFBOARD_BP_REMINDER_TWO_DAYS_AFTER_LD_PROC None TEMPLATE_ID_SECURITY_TEAM_OFFBOARD_RK_LEAVER_EMAIL None TEMPLATE_ID_SECURITY_OFFBOARD_RK_REMINDER_DAY_AFTER_LWD None TEMPLATE_ID_SECURITY_OFFBOARD_RK_REMINDER_TWO_DAYS_AFTER_LWD None TEMPLATE_ID_SECURITY_OFFBOARD_RK_REMINDER_ON_LD None TEMPLATE_ID_SECURITY_OFFBOARD_RK_REMINDER_ONE_DAY_AFTER_LD None TEMPLATE_ID_SECURITY_OFFBOARD_RK_REMINDER_TWO_DAYS_AFTER_LD_LM None TEMPLATE_ID_SECURITY_OFFBOARD_RK_REMINDER_TWO_DAYS_AFTER_LD_PROC None TEMPLATE_ID_SRE_NOTIFICATION None TEMPLATE_ID_SRE_REMINDER_DAY_AFTER_LWD None TEMPLATE_ID_SRE_REMINDER_TWO_DAYS_AFTER_LWD None TEMPLATE_ID_SRE_REMINDER_ON_LD None TEMPLATE_ID_SRE_REMINDER_ONE_DAY_AFTER_LD None TEMPLATE_ID_SRE_REMINDER_TWO_DAYS_AFTER_LD_LM None TEMPLATE_ID_SRE_REMINDER_TWO_DAYS_AFTER_LD_PROC None TEMPLATE_ID_WORKFORCE_PLANNING_LAST_WEEK_LEAVERS_EMAIL None TEMPLATE_ID_FEEDBACK_NOTIFICATION_EMAIL None TEMPLATE_ID_LEAVER_IN_PAY_CUT_OFF_HR_EMAIL None GETADDRESS_TOKEN None API Key or Domain token for getAddress() autocomplete PERFORMANCE_REVIEW_URL None Link to the performance review forms DIT_EXPERIENCE_SURVEY None Link to the DIT Experience Survey TRANSFER_TO_OGD_URL None Link to guidance for transferring to another gov department CHANGE_EMPLOYEES_LM_LINK None Link to guidance for changing the line manager for an employee RUN_DJANGO_WORKFLOWS False Enable/disable processing the workflows"},{"location":"technical-documentation/code-docs/leaver-forms/","title":"Leaver forms","text":""},{"location":"technical-documentation/code-docs/leaver-forms/#leavers.forms.leaver.radios_with_conditionals","title":"<code>radios_with_conditionals(*args, **kwargs)</code>","text":"<p>A wrapper function for Field.radios to add our custom JS to the field.</p> <p>Returns:</p> Name Type Description <code>field</code> <code>Field</code> <p>A Field object with the radios method applied to it.</p> Source code in <code>leavers/forms/leaver.py</code> <pre><code>def radios_with_conditionals(*args, **kwargs) -&gt; Field:\n\"\"\"A wrapper function for Field.radios to add our custom JS to the field.\n    Returns:\n        field (Field): A Field object with the radios method applied to it.\n    \"\"\"\nfield = Field.radios(*args, **kwargs)\nfield.context.update(has_conditionals=True)\nreturn field\n</code></pre>"},{"location":"technical-documentation/code-docs/staff-search-forms/","title":"Staff search forms","text":""},{"location":"technical-documentation/code-docs/staff-search-forms/#core.staff_search.forms.staff_search_autocomplete_field","title":"<code>staff_search_autocomplete_field(*, form, request, field_name, search_url, remove_text=None, remove_url=None, pre_html=None, field_label=None)</code>","text":"<p>Crispy forms field for an autocomplete field.</p> <p>Parameters:</p> Name Type Description Default <code>form</code> <code>Form</code> <p>The form the field belongs to.</p> required <code>request</code> <code>HttpRequest</code> <p>The request object.</p> required <code>field_name</code> <code>str</code> <p>The name of the field.</p> required <code>search_url</code> <code>str</code> <p>The URL to the search view.</p> required <code>remove_text</code> <code>Optional[str]</code> <p>The text to display on the remove button. Defaults to None.</p> <code>None</code> <code>remove_url</code> <code>Optional[str]</code> <p>The URL to the remove view. Defaults to None.</p> <code>None</code> <p>Returns:</p> Type Description <code>List[Union[Field, HTML]]</code> <p>List[Union[Field, HTML]]: A list of crispy form fields.</p> Usage <p>Inside the Form's init method <pre><code>self.helper = FormHelper()\nself.helper.layout = Layout(\n...\n*staff_search_autocomplete_field(\nform=self,\nrequest=request,\nfield_name=\"leaver_manager\",\n# The StaffSearchView URL\nsearch_url=reverse(\"leaver-manager-search\"),\n# An optional URL to remove the selected staff member\nremove_url=reverse(\"leaver-remove-line-manager\"),\n),\n...\n)\n</code></pre></p> Source code in <code>core/staff_search/forms.py</code> <pre><code>def staff_search_autocomplete_field(\n*,\nform: forms.Form,\nrequest: HttpRequest,\nfield_name: str,\nsearch_url: str,\nremove_text: Optional[str] = None,\nremove_url: Optional[str] = None,\npre_html: Optional[HTML] = None,\nfield_label: Optional[str] = None,\n) -&gt; List[Union[Field, HTML]]:\n\"\"\"Crispy forms field for an autocomplete field.\n    Args:\n        form (forms.Form):\n            The form the field belongs to.\n        request (HttpRequest):\n            The request object.\n        field_name (str):\n            The name of the field.\n        search_url (str):\n            The URL to the search view.\n        remove_text (Optional[str], optional):\n            The text to display on the remove button. Defaults to None.\n        remove_url (Optional[str], optional):\n            The URL to the remove view. Defaults to None.\n    Returns:\n        List[Union[Field, HTML]]:\n            A list of crispy form fields.\n    Usage:\n        Inside the Form's __init__ method\n        ```python\n        self.helper = FormHelper()\n        self.helper.layout = Layout(\n            ...\n            *staff_search_autocomplete_field(\n                form=self,\n                request=request,\n                field_name=\"leaver_manager\",\n                # The StaffSearchView URL\n                search_url=reverse(\"leaver-manager-search\"),\n                # An optional URL to remove the selected staff member\n                remove_url=reverse(\"leaver-remove-line-manager\"),\n            ),\n            ...\n        )\n        ```\n    \"\"\"\ncurrent_value = form[field_name].value()\nif not current_value:\ncurrent_value = form.initial.get(field_name)\noutput = []\nif field_label:\noutput.append(\nHTML(\n\"&lt;label class='govuk-label'\"\n\" for='id_{field_name}_search'&gt;\"\n\"&lt;strong&gt;{field_label}&lt;/strong&gt;&lt;/label&gt;\"\n)\n)\nif pre_html:\noutput.append(pre_html)\noutput.append(Field.text(field_name, field_width=Fluid.TWO_THIRDS))\noutput.append(\nHTML(\nrender(\nrequest,\n\"staff_search/search_field.html\",\n{\n\"search_url\": search_url,\n\"search_identifier\": field_name,\n\"staff_uuid\": current_value,\n\"remove_text\": remove_text,\n\"remove_url\": remove_url,\n},\n).content.decode()\n)\n)\nreturn output\n</code></pre>"},{"location":"technical-documentation/custom-functionality/conditional-radios/","title":"Radios with conditional content","text":"<p>In the GDS Design System, we have a pattern for conditionally revealing a related question. This is a pattern where a user is presented with further content that is contained within the radio selects.</p> <p>To acheive this in this project we have added some simple JS that will find content that relates to a radio select and show/hide it based on the radio select being selected. (see: core/static/js/conditional-radios.js).</p> <p>Since our forms are generated using Crispy Forms, you can use the <code>radios_with_conditionals</code> method to your form <code>__init__</code> method to apply the JS logic:</p> <pre><code>from django import forms\nfrom crispy_forms_gds.helper import FormHelper\nfrom crispy_forms_gds.layout import Layout, Size\nfrom leavers.forms.leaver import radios_with_conditionals\nclass ExampleForm(forms.Form):\nhow_many_fruit = forms.ChoiceField(\nlabel=\"How many fruit do you eat per day?\",\nchoices=(\n(\"0\", \"None\"),\n(\"1\", \"One\"),\n(\"2\", \"Two\"),\n(\"3\", \"Three\"),\n(\"4\", \"Four\"),\n(\"5\", \"Five\"),\n(\"6\", \"Six\"),\n(\"7\", \"Seven\"),\n(\"8\", \"Eight\"),\n(\"9\", \"Nine\"),\n(\"10\", \"Ten\"),\n)\nwidget=forms.RadioSelect,\n)\nnotes = forms.CharField(\nlabel=\"Notes\",\nrequired=False,\nwidget=forms.Textarea,\n)\ndef __init__(self, *args, **kwargs):\nsuper().__init__(*args, **kwargs)\nself.helper = FormHelper()\nself.helper.layout = Layout(\nradios_with_conditionals(\"how_many_fruit\", legend_size=Size.MEDIUM),\n)\n</code></pre> <p>The <code>radios_with_conditionals</code> method is a wrapper to the <code>Field.radios</code> method, which means you can pass through the same arguments as you would to the <code>radios</code> method.</p> <p>You can then add a wrapper <code>Div</code> with a <code>css_class</code> that dentotes which radio select it relates to:</p> <pre><code>Div(\nField.textarea(\"notes\", rows=5)\ncss_class=\"radio-conditional-field conditional-how_many_fruit-10\",\n),\n</code></pre> <p>It will need to contain the class <code>radio-conditional-field</code> and the class <code>conditional-{field_name}-{value}</code>. In the example above, the field name is <code>how_many_fruit</code> and the value is <code>10</code>, meaning that the content will be shown when the user selects the radio select with the value <code>10</code>.</p>"},{"location":"technical-documentation/custom-functionality/staff-search/","title":"Staff search","text":""},{"location":"technical-documentation/custom-functionality/staff-search/#opensearch-index","title":"OpenSearch index","text":"<p>The Staff search uses an OpenSearch index to store the data.</p>"},{"location":"technical-documentation/custom-functionality/staff-search/#staff-index-mapping-schema","title":"Staff index mapping schema","text":"core/utils/staff_index.py<pre><code>STAFF_INDEX_BODY: Mapping[str, Any] = {\n\"mappings\": {\n\"properties\": {\n\"uuid\": {\"type\": \"text\"},\n\"available_in_staff_sso\": {\"type\": \"boolean\"},\n\"staff_sso_activity_stream_id\": {\"type\": \"text\"},\n\"staff_sso_email_user_id\": {\"type\": \"text\"},\n\"staff_sso_legacy_id\": {\"type\": \"text\"},\n\"staff_sso_first_name\": {\"type\": \"text\"},\n\"staff_sso_last_name\": {\"type\": \"text\"},\n\"staff_sso_contact_email_address\": {\"type\": \"text\"},\n\"staff_sso_email_addresses\": {\"type\": \"text\"},  # Can accept list\n\"people_finder_first_name\": {\"type\": \"text\"},\n\"people_finder_last_name\": {\"type\": \"text\"},\n\"people_finder_job_title\": {\"type\": \"text\"},\n\"people_finder_directorate\": {\"type\": \"text\"},\n\"people_finder_phone\": {\"type\": \"text\"},\n\"people_finder_grade\": {\"type\": \"text\"},\n\"people_finder_email\": {\"type\": \"text\"},\n\"people_finder_photo\": {\"type\": \"text\"},\n\"people_finder_photo_small\": {\"type\": \"text\"},\n},\n},\n}\n</code></pre>"},{"location":"technical-documentation/custom-functionality/staff-search/#staff-search-component","title":"Staff search component","text":""},{"location":"technical-documentation/custom-functionality/staff-search/#example-implementation","title":"Example implementation","text":""},{"location":"technical-documentation/custom-functionality/staff-search/#add-char-field-to-the-form","title":"Add char field to the form","text":"<p>Add a char field to a form to hold the inital staff_uuid value and use the HTMX component to render the form field.</p> leavers/forms/leaver.py<pre><code>    ReturnOptions,\nSecurityClearance,\nStaffType,\nWhoIsLeaving,\n)\nclass WhoIsLeavingForm(BaseForm):\nrequired_error_messages: Dict[str, str] = {\n\"who\": \"Please tell us who you are offboarding.\",\n}\nwho = forms.ChoiceField(\nlabel=\"Who are you offboarding?\",\nwidget=forms.RadioSelect,\nchoices=WhoIsLeaving.choices,\n)\ndef __init__(self, *args, **kwargs):\nsuper().__init__(*args, **kwargs)\nself.helper = FormHelper()\nself.helper.layout = Layout(\n</code></pre> <p>Suppling <code>search_url</code> to the <code>staff_search_autocomplete_field</code> method, will tell the component which search view to use that will handle storing the data.</p> <p>Suppling <code>remove_url</code> to the <code>staff_search_autocomplete_field</code> method, will tell the component which view will handle the logic to clear the data.</p>"},{"location":"technical-documentation/custom-functionality/staff-search/#create-a-custom-search-view","title":"Create a custom search view","text":"<p>Add a View that inherits StaffSearchView to handle the search.</p> leavers/views/leaver.py<pre><code>class WhoIsLeavingView(BaseTemplateView, FormView):\ntemplate_name = \"leaving/who_is_leaving.html\"\n</code></pre> <p>The <code>query_param_name</code> is the name of the query param that will be used to pass the <code>staff_uuid</code> back to the <code>success_url</code> to be stored somewhere.</p>"},{"location":"technical-documentation/integrations/","title":"Integrations","text":"<p>This section contains details of the integrations that the service has with other systems.</p>"},{"location":"technical-documentation/integrations/people-data/","title":"People Data","text":"<p>This section contains details of the integration with People Data.</p>"},{"location":"technical-documentation/integrations/people-finder/","title":"People Finder","text":"<p>This section contains details of the integration with People Finder.</p>"},{"location":"technical-documentation/integrations/service-now/","title":"ServiceNow","text":"<p>This section contains details of the integration with ServiceNow.</p>"},{"location":"technical-documentation/integrations/uksbs/","title":"UK SBS","text":"<p>READ ME FIRST</p> <p>The Leaving DBS Service integrates with UK SBS to inform Payroll of someone leaving the department. Below are the tasks that integrate with UK SBS...</p>"},{"location":"technical-documentation/integrations/uksbs/#the-leaver-selects-their-line-manager","title":"The Leaver selects their Line Manager","text":"<p>During the Leaver's journey, we make a request to the UK SBS Hierarchy API, if we get a result that returns a Line Manager, and the Line Manager is in the Staff Index, we will prepopulate this field in the Leaver's journey.</p>"},{"location":"technical-documentation/integrations/uksbs/#scenarios","title":"Scenarios:","text":"<ul> <li>The Leaver is not in UK SBS<ul> <li>The leaver is asked to manually select their Line Manager.</li> </ul> </li> <li>The Line Manager is in UK SBS and the Staff Index<ul> <li>The Line Manager will be prepopulated, and the leaver asked to confirm or manually select their Line Manager.</li> </ul> </li> <li>The Line Manager is not in UK SBS<ul> <li>The leaver is asked to manually select their Line Manager.</li> </ul> </li> <li>The Line Manager in UK SBS doesn't exist in the Staff Index<ul> <li>The leaver is asked to manually select their Line Manager. This will intentionally cause a mismatch between the selected Line Manager and the Line Manager in UK SBS.</li> </ul> </li> </ul>"},{"location":"technical-documentation/integrations/uksbs/#the-line-manager-decides-what-to-do-with-the-leavers-line-reports","title":"The Line Manager decides what to do with the Leaver's Line reports","text":"<p>During the Line Manager's journey, we make a request to the UK SBS Hierarchy API, if we get a result that tells us the Leaver has Line reports, we will present the Line Manager with a page that asks them to inform us of the new Managers for each report.</p>"},{"location":"technical-documentation/integrations/uksbs/#scenarios_1","title":"Scenarios:","text":"<ul> <li>The Leaver is not in UK SBS<ul> <li>This will result in the Line Manager skipping this step.</li> </ul> </li> <li>The leaver has no Line reports<ul> <li>This will result in the Line Manager skipping this step.</li> </ul> </li> </ul>"},{"location":"technical-documentation/integrations/uksbs/#the-system-informs-uk-sbs-of-the-leaver","title":"The system informs UK SBS of the Leaver","text":"<p>Once the Line Manager has completed their journey, we make a request to the UK SBS API to inform UK SBS of the Leaver.</p>"},{"location":"technical-documentation/integrations/uksbs/#scenarios_2","title":"Scenarios:","text":"<ul> <li>The Leaver is not in UK SBS<ul> <li>??? What should we do here ???</li> </ul> </li> <li>The Line Manager selected matches the Line Manager in UK SBS<ul> <li>The system will inform UK SBS of the Leaver.</li> </ul> </li> <li>The Line Manager selected doesn't match the Line Manager in UK SBS<ul> <li>The Leaver doesn't have a manager in UK SBS<ul> <li>An email is sent to HR and the Line Manager that the Leaver selected informing them that UK SBS needs to be updated.</li> </ul> </li> <li>The service will ask the Line Manager in UK SBS to update on UK SBS Connect so that the Leaver's Line Manager is corrected to the one selected by the Leaver.<ul> <li>The Line Manager in UK SBS doesn't have an email_address<ul> <li>??? What should we do here ???</li> </ul> </li> <li>The Line Manager in UK SBS isn't in the Staff Index<ul> <li>??? What should we do here ???</li> </ul> </li> <li>Once the manager in UK SBS is updated and correct, the system will inform UK SBS of the Leaver.</li> </ul> </li> </ul> </li> </ul>"},{"location":"technical-documentation/integrations/uksbs/#un-handled-edge-cases","title":"Un-handled edge cases","text":""},{"location":"technical-documentation/integrations/uksbs/#the-leaver-is-not-in-uk-sbs","title":"The Leaver is not in UK SBS","text":"<p>Should we skip over the Automation and just send an email to the Line Manager asking them to fill out the UK SBS form?</p>"},{"location":"technical-documentation/integrations/uksbs/#the-line-manager-in-uk-sbs-isnt-contactable","title":"The Line Manager in UK SBS isn't contactable","text":"<p>They don't have an email in UK SBS OR they aren't in the Staff index. Who should we ask to update UK SBS to correct the Leaver's Line Manager? HR and the Line Manager that the Leaver selected?</p>"}]}